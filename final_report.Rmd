---
title: "Final Report"
author: "Saryu Patel, Malvika Venkataraman, Fang (Amy) Liu, Dani Rochez"
output:
  html_document
---

# NYC Condom Distribution

Load required libraries and setup.

```{r, message=FALSE}
library(tidyverse)
library(rvest)
library(httr)

knitr::opts_chunk$set(
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Motivation

Condoms are highly effective in preventing the sexual transmission of HIV and other sexually transmitted infections. Condom distribution is a cost-effective structural intervention that provides communities with the resources needed to prevent the spread of HIV. Making condoms widely available through condom distribution programs is integral to successful HIV prevention. The Health Department's NYC Condom Availability Program gives away more than 30 million free safer sex products every year to over 3,500 locations throughout the five boroughs. These free products include male condoms, female condoms, and lubricant, and are distributed at local businesses, community-based organizations and health care facilities.

The motivation for this project is to explore the distribution of free condoms across different areas in NYC. We want to determine areas of the city where more free condoms can be distributed, and ensure that equal amounts are being distributed for both females and males. We also would like to explore whether certain types of venues have made more of an effort to distribute free condoms than others.

## Related Work

We all have an interest in sexual health and were looking for a project that could make a difference in the city we live in- NYC. This dataset melded our two interests.

## Initial Questions

* How does the availability of products for females and males vary per type of venue?
* How does the availability of products for females and males vary per borough?
* How does the number of venue types vary per borough?
* How does the number of venue subtypes vary per borough?
* What is the most popular type of venue from which to distribute condoms?
* What is the most popular subtype of venue from which to distribute condoms?

## Data  

We used data from the NYC condom availability program for our analysis. The data is publicly accessible and is refreshed on a daily basis. In short, the program maintains a list of active venues across the five boroughs of NYC that offers free safer sex products; this list is updated with support from the NYC Department of Health and Mental Hygiene. Each row of the dataset represents pertinent information related to a single venue which distributes NYC safer sex products. The dataset can be downloaded directly or accessed by using NYC OpenData's API, in `JSON` or `CSV` formats. For our project, we accessed the data directly using the API to improve reproducibility and make it easier to update results to reflect new data, since the data is updated regularly.  

Link for data: [NYC Condom Availability Program - HIV condom distribution locations](www.https://data.cityofnewyork.us/Health/NYC-Condom-Availability-Program-HIV-condom-distrib/4kpn-sezh) 

### Variables of interest
**Facility**  
* `facility_pk` - unique facility identifier  
* `facilityname` - name of the facility  
* `partnertype` - the type of organization the venue is  
* `partner_subtype` - subtype of organization the venue is 
* `phone`  

**Location**  
* `address` - address of the service location  
* `borough` - the borough the facility/venue is located in  
* `zipcode`   
* `latitude`  
* `longitude`  

**Safer sex products availability**  
* `condoms_male` - whether the location offers condoms for males (1 = yes, 0 = no)  
* `condoms_female` - whether the location offers female/insertive condoms  
* `lubricant` - whether the location offers lubricant 

### Data Cleaning  

```{r, message=FALSE}
condom_data = 
  GET("https://data.cityofnewyork.us/resource/4kpn-sezh.csv") %>% 
  content("parsed")

cleaned_data = 
  condom_data %>% 
  select(facility_pk, facilityname, partnertype, partner_type_detailed, 
         address, borough, zipcode, latitude, longitude, phone, condoms_male,
         fc2_female_insertive_condoms, lubricant) %>% 
  rename(condoms_female = fc2_female_insertive_condoms) %>% 
  rename(partner_subtype = partner_type_detailed) %>% 
  mutate(
    condoms_male = as.factor(condoms_male), 
    condoms_male = fct_recode(condoms_male, "0" = "FALSE", "1" = "TRUE"),
    condoms_female = as.factor(condoms_female),
    condoms_female = fct_recode(condoms_female, "0" = "FALSE", "1" = "TRUE"),
    lubricant = as.factor(lubricant),
    lubricant = fct_recode(lubricant, "0" = "FALSE", "1" = "TRUE"),
    borough = as.factor(borough)
  )

cleaned_data$partnertype[cleaned_data$partnertype == "Community Based Organization/Non-Profit"] =
  "Community-Based Organization/Non-Profit"
```  

To clean the data, we first imported the dataset as a CSV and parsed it. The variables of interest were then selected and renamed. The `servicetype` and `service_category` variables were dropped because they only contain 1 category; we also excluded the hours of operation because of excess incomplete/null data. Other variables, such as `council_district`, `census_tract`, `bin`, `bbl`, and `nta` were dropped because they are irrelevant to our key research questions. After finalizing and renaming some of our variables for convenience, we converted  `condoms_male`, `condoms_female`, `lubricant`, and `borough` into factors and reordered the levels to facilitate data processing and manipulation in later steps. Upon diving in to exploratory data analysis, we noticed that `partnertype` "Community-Based Organization/Non-Profit" was also recorded with a slightly different format (without a hyphen between "Community" and "Based"), so we edited this column to fix any inconsistencies. As a result of the cleaning steps above, our final dataset contains **`r nrow(cleaned_data)`** rows and **`r ncol(cleaned_data)`** columns. 

## Exploratory Analysis

### Interactive Map

When we first took a look at the data, we were excited about the possibility of utilizing the `latitude` and `longitude` variables to create a map of where free safe sex products are located in NYC. Our goal was to create an interactive tool that would allow users to explore locations by borough and type of safe sex product. 

We started off by trying to plot all the products as points in leaflet, but the number of points was overwhelming, and as a result, unreadable. To mitigate this issue, we decided to cluster the markers on the map, so that the number of locations in a particular area was still represented, but visually, the map is more readable. 

```{r}
# cluster markers 
leaflet(cleaned_data_plot) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addMarkers(clusterOptions = markerClusterOptions(),
             lng = cleaned_data_plot$longitude, lat = cleaned_data_plot$latitude,
             popup = paste("Facility Name:", cleaned_data_plot$facilityname, "<br>",
                           "Partner Type:", cleaned_data_plot$partnertype, "<br>",
                           "Partner Subtype:", cleaned_data_plot$partner_subtype, "<br>",
                           "Address:", cleaned_data_plot$address, "<br>",
                           "Borough:", cleaned_data_plot$borough, "<br>",
                           "Phone:", cleaned_data_plot$phone, "<br>",
                           "Male Condoms:", cleaned_data_plot$condoms_male, "<br>",
                           "Female Condoms:", cleaned_data_plot$condoms_female, "<br>",
                           "Lubricant:", cleaned_data_plot$lubricant)) %>%
  setView(lat = 40.7, lng = -74, zoom = 10)
```

When looking at all of the marker clusters, we noticed a cluster located in Africa. Since our dataset is specific to NYC, we decided to investigate this. After examining the specific rows, we found out that this was due to "0" values in the `longitude` and `latitude` variables. These were likely missing values, so we filtered out values that were “0” for the purpose of the map.

To make this map as user-friendly as possible, we decided to make the values of  the variables `facilityname`, `partnertype`, `partner_subtype`, `address`, `borough`, `phone`, `condoms_male`, `condoms_female`, and `lubricant`, display when the user clicks on a specific marker. This way the interactive map can be utilized to display all the relevant information needed for a user to find a location that dispenses the free safe sex product(s) they are looking for. In our data cleaning, we had recoded the variables `condoms_male`, `condoms_female`, and `lubricant` to factors with values “0”, and “1.” As a result, “0” and “1” were displaying on the marker. Since this is not user-friendly, for the plot, we recoded the factor values to “No” and “Yes.” 

```{r}
# filtering and factor recoding - cleaning data for the purposes of the plot
cleaned_data_plot =
    cleaned_data %>% 
    filter(longitude != 0) %>% #removed 0 long and lat
    filter(latitude != 0) %>%
    mutate(condoms_male = fct_recode(condoms_male, "No" = "0", "Yes" = "1")) %>%
    mutate(condoms_female = fct_recode(condoms_female, "No" = "0", "Yes" = "1")) %>%
    mutate(lubricant = fct_recode(lubricant, "No" = "0", "Yes" = "1"))
```

While the leaflet map displayed all of they key information we were looking to represent, our goal was to create a leaflet map in a shiny app, so that the user would be able to filter the map by type of safe sex product. To do this we explored various widget types, experimenting with select boxes and radio buttons, before eventually deciding on the checkbox group widget, because it allowed the user to select various combinations of safe sex products most easily. 

```{r}
# checkbox group inputs within ui variable
ui <- fluidPage(
    titlePanel("Where Can I Find Safe Sex Products in NYC?"),
    tags$head(tags$style(
        type = "text/css",
        "#controlPanel {background-color: rgba(255,255,255,0.8);}",
        ".leaflet-top.leaflet-right .leaflet-control {margin-right: 210px;}")),
    leafletOutput(outputId = "mymap", width = "100%"),
    sidebarPanel(top = 10, right = 10, width = 210,
                 checkboxGroupInput("condoms_men", "Male Condoms?", 
                                    choices = unique(cleaned_data_plot$condoms_male)),
                 checkboxGroupInput("condoms_fem", "Female Condoms?", 
                                    choices = unique(cleaned_data_plot$condoms_female)),
                 checkboxGroupInput("lube", "Lubricant?", 
                                    choices = unique(cleaned_data_plot$lubricant))))
```

We then spent time working on the aesthetics of app. We added a title to the top, instructions on how to use the map, and we moved the checkbox panel to the bottom. 

### Male and Female Condoms Availability

### Venues per Borough

### Popular Venues

## Additional Analyses

## Discussion and Conclusions